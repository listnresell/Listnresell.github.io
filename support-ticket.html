<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Support Ticket</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <h1 class="text-2xl font-semibold text-gray-900">Support Center</h1>
        <nav class="hidden md:flex space-x-6 text-gray-700">
          <a
            class="hover:text-blue-600 font-medium"
            href="https://listnresell.github.io/"
            target="_blank"
            rel="noopener noreferrer"
            >Home</a
          >
          <a class="hover:text-blue-600 font-medium" href="#">Knowledge Base</a>
          <a class="hover:text-blue-600 font-medium" href="#">Contact</a>
          <a class="hover:text-blue-600 font-medium" href="admin-dashboard.html"
            >Support Tickets</a
          >
        </nav>
        <button
          aria-label="Open menu"
          class="md:hidden text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-600"
          id="mobile-menu-button"
        >
          <i class="fas fa-bars fa-lg"></i>
        </button>
      </div>
    </div>
    <div class="md:hidden hidden bg-white border-t border-gray-200" id="mobile-menu">
      <nav class="px-4 py-3 space-y-1">
        <a
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600"
          href="https://listnresell.github.io/"
          target="_blank"
          rel="noopener noreferrer"
          >Home</a
        >
        <a
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600"
          href="#"
          >Knowledge Base</a
        >
        <a
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600"
          href="#"
          >Contact</a
        >
        <a
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600"
          href="admin-dashboard.html"
          >Support Tickets</a
        >
      </nav>
    </div>
  </header>
  <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h2 class="text-3xl font-semibold text-gray-900 mb-8 text-center">
      Submit a Support Ticket
    </h2>
    <form
      action="#"
      class="bg-white shadow-md rounded-lg p-8 max-w-3xl mx-auto"
      id="supportTicketForm"
      method="POST"
      novalidate=""
    >
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="name">
          Full Name <span class="text-red-600">*</span>
        </label>
        <input
          class="w-full border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          id="name"
          name="name"
          placeholder="Your full name"
          required=""
          type="text"
        />
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="email">
          Email Address <span class="text-red-600">*</span>
        </label>
        <input
          class="w-full border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          id="email"
          name="email"
          placeholder="you@example.com"
          required=""
          type="email"
        />
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="subject">
          Subject <span class="text-red-600">*</span>
        </label>
        <input
          class="w-full border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          id="subject"
          name="subject"
          placeholder="Brief summary of your issue"
          required=""
          type="text"
        />
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="category">
          Category <span class="text-red-600">*</span>
        </label>
        <select
          class="w-full border border-gray-300 rounded-md px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          id="category"
          name="category"
          required=""
        >
          <option disabled="" selected="" value="">
            Select a category
          </option>
          <option value="technical">Technical Issue</option>
          <option value="billing">Billing</option>
          <option value="account">Account Management</option>
          <option value="feature">Feature Request</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="description">
          Description <span class="text-red-600">*</span>
        </label>
        <textarea
          class="w-full border border-gray-300 rounded-md px-4 py-3 resize-y focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          id="description"
          name="description"
          placeholder="Please provide a detailed description of your issue"
          required=""
          rows="6"
        ></textarea>
      </div>
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2" for="attachment">
          Attachment (optional)
        </label>
        <input
          accept=".jpg,.jpeg,.png,.pdf,.doc,.docx"
          class="w-full text-gray-700"
          id="attachment"
          name="attachment"
          type="file"
        />
      </div>
      <button
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        type="submit"
      >
        Submit Ticket
      </button>
    </form>

    <section
      id="userTicketsSection"
      class="max-w-3xl mx-auto mt-12 bg-white shadow-md rounded-lg p-6"
      aria-live="polite"
    >
      <h3 class="text-2xl font-semibold text-gray-900 mb-6 text-center">
        Your Submitted Tickets & Responses
      </h3>
      <div id="userTicketsContainer" class="space-y-6"></div>
      <p
        id="noTicketsMessage"
        class="text-center text-gray-600 italic hidden"
      >
        You have not submitted any tickets yet.
      </p>
    </section>
  </main>
  <footer class="bg-white border-t border-gray-200 mt-16">
    <div
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col md:flex-row justify-between items-center text-gray-600 text-sm"
    >
      <p>Â© 2024 Support Center. All rights reserved.</p>
      <div class="flex space-x-6 mt-4 md:mt-0">
        <a aria-label="Facebook" class="hover:text-blue-600" href="#"
          ><i class="fab fa-facebook fa-lg"></i
        ></a>
        <a aria-label="Twitter" class="hover:text-blue-600" href="#"
          ><i class="fab fa-twitter fa-lg"></i
        ></a>
        <a aria-label="LinkedIn" class="hover:text-blue-600" href="#"
          ><i class="fab fa-linkedin fa-lg"></i
        ></a>
        <a aria-label="Instagram" class="hover:text-blue-600" href="#"
          ><i class="fab fa-instagram fa-lg"></i
        ></a>
      </div>
    </div>
  </footer>
  <script>
    const mobileMenuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");

    mobileMenuButton.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
    });

    const form = document.getElementById("supportTicketForm");
    const responseMessage = document.getElementById("responseMessage");
    const userTicketsContainer = document.getElementById("userTicketsContainer");
    const noTicketsMessage = document.getElementById("noTicketsMessage");

    // Use localStorage key for tickets
    const TICKETS_STORAGE_KEY = "supportTickets";
    // Use localStorage key for current user email to identify tickets
    const CURRENT_USER_EMAIL_KEY = "currentUserEmail";

    // Save current user email to localStorage for session-like behavior
    function saveCurrentUserEmail(email) {
      localStorage.setItem(CURRENT_USER_EMAIL_KEY, email.toLowerCase());
    }

    // Get current user email from localStorage
    function getCurrentUserEmail() {
      return localStorage.getItem(CURRENT_USER_EMAIL_KEY) || null;
    }

    // Format date nicely
    function formatDate(isoString) {
      const d = new Date(isoString);
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // Render user's tickets and their responses
    function renderUserTickets() {
      const currentUserEmail = getCurrentUserEmail();
      if (!currentUserEmail) {
        userTicketsContainer.innerHTML = "";
        noTicketsMessage.textContent =
          "Please submit a ticket first to see your tickets and responses.";
        noTicketsMessage.classList.remove("hidden");
        return;
      }

      const tickets = JSON.parse(localStorage.getItem(TICKETS_STORAGE_KEY)) || [];
      const userTickets = tickets.filter(
        (t) => t.email.toLowerCase() === currentUserEmail
      );

      if (userTickets.length === 0) {
        userTicketsContainer.innerHTML = "";
        noTicketsMessage.textContent = "You have not submitted any tickets yet.";
        noTicketsMessage.classList.remove("hidden");
        return;
      }

      noTicketsMessage.classList.add("hidden");
      userTicketsContainer.innerHTML = "";

      userTickets.forEach((ticket) => {
        const card = document.createElement("div");
        card.className =
          "border border-gray-300 rounded-md p-4 bg-white shadow-sm";

        const header = document.createElement("div");
        header.className = "flex justify-between items-center";

        const subject = document.createElement("h4");
        subject.className = "text-lg font-semibold text-gray-900";
        subject.textContent = ticket.subject;

        const status = document.createElement("span");
        status.className =
          "text-sm font-semibold px-2 py-1 rounded-full " +
          (ticket.status === "Open"
            ? "bg-yellow-100 text-yellow-800"
            : ticket.status === "Responded"
            ? "bg-green-100 text-green-800"
            : "bg-gray-100 text-gray-700");
        status.textContent = ticket.status;

        header.appendChild(subject);
        header.appendChild(status);

        const createdAt = document.createElement("p");
        createdAt.className = "text-xs text-gray-500 mt-1";
        createdAt.textContent = `Created: ${formatDate(ticket.createdAt)}`;

        const description = document.createElement("p");
        description.className = "mt-3 text-gray-700 whitespace-pre-wrap";
        description.textContent = ticket.description;

        // Attachment if exists
        let attachmentBlock = null;
        if (ticket.attachmentData) {
          attachmentBlock = document.createElement("div");
          attachmentBlock.className = "mt-3";
          const attachLink = document.createElement("a");
          attachLink.href = ticket.attachmentData;
          attachLink.download = ticket.attachmentName;
          attachLink.target = "_blank";
          attachLink.rel = "noopener noreferrer";
          attachLink.className =
            "text-blue-600 hover:underline flex items-center space-x-2";
          const attachIcon = document.createElement("i");
          attachIcon.className = "fas fa-paperclip";
          const attachNameSpan = document.createElement("span");
          attachNameSpan.textContent = ticket.attachmentName;
          attachLink.appendChild(attachIcon);
          attachLink.appendChild(attachNameSpan);
          attachmentBlock.appendChild(attachLink);
        }

        // Responses block
        const responsesBlock = document.createElement("div");
        responsesBlock.className = "mt-4";
        const responsesTitle = document.createElement("h5");
        responsesTitle.className = "font-semibold text-gray-900 mb-2";
        responsesTitle.textContent = "Responses";
        responsesBlock.appendChild(responsesTitle);

        if (ticket.responses.length === 0) {
          const noResponses = document.createElement("p");
          noResponses.className = "text-gray-600 italic";
          noResponses.textContent = "No responses yet.";
          responsesBlock.appendChild(noResponses);
        } else {
          ticket.responses.forEach((resp) => {
            const respDiv = document.createElement("div");
            respDiv.className =
              "border border-gray-300 rounded-md p-3 mb-3 bg-gray-50";

            const respDate = document.createElement("p");
            respDate.className = "text-xs text-gray-500 mb-1";
            respDate.textContent = `On ${formatDate(resp.date)}`;

            const respText = document.createElement("p");
            respText.className = "text-gray-700 whitespace-pre-wrap";
            respText.textContent = resp.text;

            respDiv.appendChild(respDate);
            respDiv.appendChild(respText);
            responsesBlock.appendChild(respDiv);
          });
        }

        card.appendChild(header);
        card.appendChild(createdAt);
        card.appendChild(description);
        if (attachmentBlock) card.appendChild(attachmentBlock);
        card.appendChild(responsesBlock);

        userTicketsContainer.appendChild(card);
      });
    }

    // On form submit, save ticket and store user email for session
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      responseMessage.textContent = "";
      responseMessage.className = "";

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData(form);

      const ticket = {
        id: crypto.randomUUID(),
        name: formData.get("name").trim(),
        email: formData.get("email").trim().toLowerCase(),
        subject: formData.get("subject").trim(),
        category: formData.get("category"),
        description: formData.get("description").trim(),
        createdAt: new Date().toISOString(),
        attachmentName: null,
        attachmentType: null,
        attachmentData: null,
        responses: [],
        status: "Open",
      };

      const attachmentFile = formData.get("attachment");
      if (attachmentFile && attachmentFile.size > 0) {
        try {
          ticket.attachmentData = await fileToBase64(attachmentFile);
          ticket.attachmentName = attachmentFile.name;
          ticket.attachmentType = attachmentFile.type;
        } catch (err) {
          responseMessage.textContent = "Failed to read attachment file.";
          responseMessage.className =
            "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md";
          return;
        }
      }

      try {
        const existingTickets =
          JSON.parse(localStorage.getItem(TICKETS_STORAGE_KEY)) || [];

        existingTickets.push(ticket);

        localStorage.setItem(
          TICKETS_STORAGE_KEY,
          JSON.stringify(existingTickets)
        );

        // Save current user email for session
        saveCurrentUserEmail(ticket.email);

        responseMessage.textContent =
          "Your support ticket has been submitted successfully. We will get back to you shortly.";
        responseMessage.className =
          "bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-md";

        form.reset();

        // Refresh user tickets display
        renderUserTickets();
      } catch (error) {
        responseMessage.textContent =
          "There was an error submitting your ticket. Please try again later.";
        responseMessage.className =
          "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md";
      }
    });

    // Convert file to base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
      });
    }

    // On page load, render tickets for current user if any
    window.addEventListener("load", () => {
      renderUserTickets();
    });
  </script>
</body>
</html>
